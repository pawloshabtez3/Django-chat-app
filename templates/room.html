{% extends 'base.html' %}

{% block title %}{{room}} | Django Chat{% endblock %}

{% block content %}
<div class="page">
  <div class="layout">
    <header class="header">
      <div class="room-meta">
        <div class="pill">Live room</div>
        <h1 class="room-title">{{room}}</h1>
      </div>
      <div class="username">Signed in as {{username}}</div>
    </header>

    <section class="chat-shell">
      <div id="display"></div>
    </section>

    <form class="composer" id="post-form">
      {% csrf_token %}
      <input type="hidden" name="username" id="username" value="{{username}}"/>
      <input type="hidden" name="room_id" id="room_id" value="{{room_details.id}}"/>
      <input class="input" type="text" name="message" id="message" placeholder="Type your message..." autocomplete="off" />
      <input class="btn" type="submit" value="Send">
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function(){
  setInterval(function(){
    $.ajax({
      type: 'GET',
      url : "/getMessages/{{room}}/",
      success: function(response){
        $("#display").empty();
        for (var key in response.messages)
        {
          var temp="<div class='message'><b>"+response.messages[key].user+"</b><p>"+response.messages[key].value+"</p><span class='time'>"+response.messages[key].date+"</span></div>";
          $("#display").append(temp);
        }
        var display = document.getElementById('display');
        display.scrollTop = display.scrollHeight;
      },
      error: function(){
        alert('An error occured');
      }
    });
  },1000);
});
</script>

<script type="text/javascript">
  $(document).on('submit','#post-form',function(e){
    e.preventDefault();

    $.ajax({
      type:'POST',
      url:'/send',
      data:{
        username:$('#username').val(),
        room_id:$('#room_id').val(),
        message:$('#message').val(),
        csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
      },
      success: function(data){
        // no-op; UI updates on poll
      }
    });
    document.getElementById('message').value = '';
  });
</script>
{% endblock %}